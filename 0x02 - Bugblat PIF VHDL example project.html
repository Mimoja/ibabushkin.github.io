<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title>Bugblat PIF VHDL howto</title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">body{margin:40px auto;max-width:700px;text-align:justify;line-height:1.6;font-size:16px;color:#444;padding:0 10px}h1,h2,h3{line-height:1.2}</style>
  <style type="text/css">img{margin: 10px; max-width:600px; border: 2px solid #d0d0d0;}</style>
  <style type="text/css">pre{border-radius: 10px;min-width:700px; margin-left: -10%;padding: 3%;padding-left: 7%; background: #002451; </style>

<link rel="stylesheet" href="/highlight/styles/tomorrow-night-blue.css">
<script src="/highlight/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

</head>
<body>
<h1>/sys/class/mimoja</h1>
<div id="header">
<h1 class="title">Bugblat PIF VHDL howto</h1>
</div>
<hr />
<p><strong>TLDR:</strong></p>
<ul>
<li>Download Lattice Diamond</li>
<li>Add <code>SYSCONFIG SDM_PORT=PROGRAMN SLAVE_SPI_PORT=ENABLE;</code> to your .lpf file.</li>
<li>Synthesize your project</li>
<li>Flash JEDEC file using pifload.py</li>
</ul>
<hr />
<h2 id="resources">Resources</h2>
<p>Bugblat does not longer list the resources for the original PIF on their site. They can be found here:</p>
<ul>
<li><a href="https://www.bugblat.com/products/pif/pif.pdf">Manual</a></li>
<li><a href="https://www.bugblat.com/products/pif/pif_sch.pdf">Schematic</a></li>
<li><a href="https://www.bugblat.com/products/pif/pif.zip">Software/Firmware Bundle</a></li>
<li><a href="https://github.com/bugblat/pif">Github Repo</a></li>
</ul>
<h2 id="download-lattice-diamond-on-your-pc">Download Lattice Diamond on your PC</h2>
<ul>
<li>Go to the <a href="http://www.latticesemi.com/latticediamond">Lattice Diamond Portal</a></li>
<li>Create an Account</li>
<li>Download Lattice Diamond and install</li>
<li>Start Diamond, copy your Mac to the <a href="http://www.latticesemi.com/en/Support/Licensing/DiamondAndiCEcube2SoftwareLicensing/DiamondFree.aspx">Licensing wizzard</a>.</li>
<li>Copy the emailed license.dat to the prompted folder.</li>
</ul>
<h2 id="pif-example-project">PIF example project</h2>
<p>Create a new project:</p>
<p><a href="tech/0x02/diamond_new_project.PNG"><img src="tech/0x02/diamond_new_project_scaled.jpg" title="new project" /></a></p>
<p>First of all we will locate the <code>$ProjectName.lpf</code> file and add the line</p>
<p><code>SYSCONFIG JTAG_PORT=DISABLE SDM_PORT=PROGRAMN I2C_PORT=DISABLE SLAVE_SPI_PORT=ENABLE;</code></p>
<p>Therefore we wont lock ourself out of I2C-&gt;SPI flashing.</p>
<p>Now add a VHDL file to the project:</p>
<p><a href="tech/0x02/diamond_new_file.PNG"><img src="tech/0x02/diamond_new_file_scaled.jpg" title="new file" /></a></p>
<pre><code>LIBRARY ieee;
USE ieee.std_logic_1164.all;

ENTITY blinking_led IS
   PORT(
      LEDR : OUT STD_LOGIC;
      LEDG : OUT STD_LOGIC
      );
END blinking_led;

ARCHITECTURE behavior OF blinking_led IS
   SIGNAL clk  : STD_LOGIC;
   SIGNAL led : STD_LOGIC;
   --oscillator
   COMPONENT OSCH
      GENERIC(
            NOM_FREQ: string := &quot;53.20&quot;);
      PORT( 
            STDBY    : IN  STD_LOGIC;
            OSC      : OUT STD_LOGIC;
            SEDSTDBY : OUT STD_LOGIC);
   END COMPONENT;
BEGIN
   --oscillator
   OSCInst0: OSCH
       GENERIC MAP (NOM_FREQ  =&gt; &quot;133.00&quot;)
       PORT MAP (STDBY =&gt; &#39;0&#39;, OSC =&gt; clk, SEDSTDBY =&gt; OPEN);
   PROCESS(clk)
        CONSTANT LIMIT : INTEGER := 10000000;
        VARIABLE count : INTEGER RANGE 0 TO LIMIT;
    BEGIN
      IF rising_edge(clk) THEN
         IF(count &lt; LIMIT) THEN
            count := count + 1;
         ELSE
            count := 0;
            led &lt;= NOT led;
         END IF;
      END IF;
    END PROCESS;
    LEDG &lt;= NOT led;
    LEDR &lt;= led;   
END behavior;</code></pre>
<p>Next we need to map <code>LEDR</code> and <code>LEDG</code> to the board pins. Therefore we add to our projects .lpf file:</p>
<pre><code>LOCATE COMP &quot;LEDR&quot; SITE &quot;112&quot; ;
LOCATE COMP &quot;LEDG&quot; SITE &quot;113&quot; ;

IOBUF PORT &quot;LEDR&quot; IO_TYPE=LVCMOS33 PULLMODE=DOWN ;
IOBUF PORT &quot;LEDG&quot; IO_TYPE=LVCMOS33 PULLMODE=DOWN ;</code></pre>
<p>On the left in the <code>process</code> tab we can now choose <code>JEDEC File</code> and use a Doubleclick on that target to synthesize.</p>
<p><a href="tech/0x02/diamond_syn.PNG"><img src="tech/0x02/diamond_syn_scaled.jpg" title="new file" /></a></p>
<p>Find the <code>.jed</code> file in your implementation folder and copy it over to your raspberry pi, where you can flash via:</p>
<p><code>sudo python pif/software/pifload.py blinky_impl1.jed</code></p>
<p>assuming your file is called <code>blinky_impl1.jed</code>.</p>
<pre><code>====================hello==========================
Configuration file is fpga/blinky_impl1.jed
Using pif library version: &#39;libpif,Nov 18 2017,22:23:31&#39;

XO2 Device ID: 012bd043  - device is an XO2-7000HC
XO2 Trace ID : 00.44.30.77_87.20.30.2B
XO2 usercode from Flash:  00.00.00.00
XO2 usercode from SRAM :  00.00.00.00
JEDEC file is fpga/blinky_impl1.jed
starting to read JEDEC file
first configuration data line: 21
. . . . . .
last configuration data line: 1586
1566 frames
finished reading JEDEC file
erasing configuration flash ...  erased
programming configuration flash ...  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . programmed
transferring ...
configuration finished.

==================== bye ==========================</code></pre>
<p>You should now have a led blinking pif board.</p>
<hr />
<h2 id="resetting-the-pif-in-case-spi-slave-was-disabled">Resetting the PIF in case SPI slave was disabled</h2>
<p>If you don't sythesize with <code>SDM_PORT=PROGRAMN SLAVE_SPI_PORT=ENABLE</code> the PIF will no longer respond to your flashing attemps.</p>
<p>This is noticeable by the <strong>reported IDs</strong> beeing all <strong>zero</strong>.</p>
<pre><code>$ sudo python pif/software/pifload.py pif/firmware/7000/flasher/syn/pif_flasher.jed
====================hello==========================
Configuration file is pif/firmware/7000/flasher/syn/pif_flasher.jed
Using pif library version: &#39;libpif,Nov 18 2017,22:23:31&#39;

XO2 Device ID: 00000000  - unrecognised ID!
XO2 Trace ID : 00.00.00.00_00.00.00.00
XO2 usercode from Flash:  00.00.00.00
XO2 usercode from SRAM :  00.00.00.00
JEDEC file is fpga/blinky_impl1.jed
starting to read JEDEC file
JEDEC file does not match FPGA

  FPGA is XO2-256HC

  JEDEC identifies as &quot;NOTE DEVICE NAME:        LCMXO2-7000HC-5TQFP144*&quot;

==================== bye ==========================</code></pre>
<p>Bugblat added a reset test pad that can be used to bring the PIF back up.</p>
<p><a href="tech/0x02/pif_reset.jpg"><img src="tech/0x02/pif_reset_scaled.jpg" title="pif reset pad" /></a></p>
<p>Connect the testpad to <code>GND</code> and recover by flashing the default firmware:</p>
<p><code>sudo python pif/software/pifload.py pif/firmware/$VERSION$/flasher/syn/pif_flasher.jed</code></p>
<p>Replace <code>$VERSION$</code> either with <code>7000</code> or with <code>1200</code> based on your hardware.</p>
<br>
<a href="index.html">home</a>
</body>
</html>
